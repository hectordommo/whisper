<!DOCTYPE html>
<html>
<head>
    <title>Test Recording</title>
    <meta name="csrf-token" content="test">
</head>
<body>
    <h1>Audio Recording Test</h1>
    <button id="start">Start Recording</button>
    <button id="stop" disabled>Stop Recording</button>
    <div id="status"></div>
    <div id="log" style="margin-top: 20px; padding: 10px; background: #f0f0f0; max-height: 400px; overflow-y: auto;"></div>

    <script>
        let mediaRecorder;
        let chunks = [];
        let startTime;
        
        const log = (msg) => {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
            console.log(msg);
        };

        document.getElementById('start').addEventListener('click', async () => {
            try {
                log('Requesting microphone access...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('Microphone access granted');
                
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
                log(`Using MIME type: ${mimeType}`);
                
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                chunks = [];
                startTime = Date.now();
                
                mediaRecorder.ondataavailable = (event) => {
                    log(`Data available: ${event.data.size} bytes`);
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstart = () => {
                    log('Recording started');
                    document.getElementById('status').textContent = 'Recording...';
                };
                
                mediaRecorder.onstop = () => {
                    log('Recording stopped');
                    document.getElementById('status').textContent = 'Stopped';
                    const blob = new Blob(chunks, { type: mimeType });
                    log(`Total size: ${blob.size} bytes`);
                };
                
                mediaRecorder.onerror = (event) => {
                    log(`Error: ${event.error}`);
                };
                
                // Start with 5-second chunks for testing
                mediaRecorder.start(5000);
                log('MediaRecorder.start(5000) called');
                
                document.getElementById('start').disabled = true;
                document.getElementById('stop').disabled = false;
            } catch (err) {
                log(`ERROR: ${err.message}`);
            }
        });
        
        document.getElementById('stop').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
            }
        });
    </script>
</body>
</html>
